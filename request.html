<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Stick&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif
        }

        .vsBoom-stage {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            pointer-events: none;
            z-index: 9999
        }

        .vsBoom-text {
            font-size: clamp(48px, 12vw, 140px);
            font-weight: 900;
            color: #fff;
            letter-spacing: 0.04em;
            transform-origin: center;
            filter: drop-shadow(0 6px 18px rgba(255, 80, 30, 0.25));
            position: relative;
            padding: 200px;
            display: none
        }

        .vsBoom-text::before {
            content: "";
            position: absolute;
            inset: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 20vmin;
            height: 20vmin;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 220, 140, 0.95) 0%, rgba(255, 130, 60, 0.6) 35%, rgba(255, 80, 30, 0.12) 60%, transparent 70%);
            z-index: -2
        }

        .vsBoom-text::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 2px;
            height: 2px;
            transform: translate(-50%, -50%) scale(0);
            background: transparent;
            box-shadow: 0 -140px currentColor, 0 140px currentColor, 140px 0 currentColor, -140px 0 currentColor, 100px -100px currentColor, -100px -100px currentColor, 100px 100px currentColor, -100px 100px currentColor;
            color: rgba(255, 200, 80, 0.95);
            z-index: -1;
            border-radius: 1px;
            opacity: 0
        }

        .vsBoom-sparks span {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(255, 210, 130, 0.95);
            opacity: 0;
            filter: blur(0.6px)
        }

        @keyframes vsBoom-popShrink {
            0% {
                transform: scale(0.2) rotate(-720deg);
                opacity: 0;
                filter: blur(6px)
            }

            50% {
                transform: scale(1.6) rotate(4deg);
                opacity: 1;
                filter: blur(0)
            }

            100% {
                transform: scale(1) rotate(0deg)
            }
        }

        @keyframes vsBoom-flash {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1
            }

            20% {
                transform: translate(-50%, -50%) scale(1.6);
                opacity: 0.9
            }

            100% {
                transform: translate(-50%, -50%) scale(2.2);
                opacity: 0
            }
        }

        @keyframes vsBoom-rays {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1
            }

            30% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1
            }

            100% {
                transform: translate(-50%, -50%) scale(1.18);
                opacity: 0
            }
        }

        @keyframes vsBoom-sparkMove {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1
            }

            100% {
                transform: translate(var(--vsdx), var(--vsdy)) scale(0.9);
                opacity: 0
            }
        }

        .vsBoom-stage.animate .vsBoom-text::before {
            animation: vsBoom-flash 600ms ease-out 400ms forwards
        }

        .vsBoom-stage.animate .vsBoom-text::after {
            animation: vsBoom-rays 600ms cubic-bezier(0.2, 0.9, 0.3, 1) 420ms forwards
        }

        .vsBoom-stage.animate .vsBoom-sparks span {
            animation: vsBoom-sparkMove 700ms cubic-bezier(0.15, 0.9, 0.3, 1) 420ms forwards
        }

        .vsBoom-text.show {
            display: block;
            animation: vsBoom-popShrink 800ms cubic-bezier(0.2, 0.9, 0.3, 1) forwards
        }

        .match-user-card-container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: left;
            overflow: hidden
        }

        .match-user-card {
            position: absolute;
            background: #333;
            color: white;
            font-family: "Stick", sans-serif;
            width: 50%;
            height: 100%;
            font-size: 2rem;
            justify-content: center;
            align-items: center;
            display: none
        }

        .match-user-card.left {
            clip-path: polygon(0 0, 100% 0, 90% 100%, 0 100%);
            animation: MatchUserCardLeft 0.5s forwards;
            display: flex
        }

        .match-user-card.right {
            clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%);
            animation: MatchUserCardRight 0.5s forwards;
            display: flex
        }

        @keyframes MatchUserCardLeft {
            0% {
                left: -50%
            }

            100% {
                left: 0%
            }
        }

        @keyframes MatchUserCardRight {
            0% {
                left: 100%
            }

            100% {
                left: 50%
            }
        }

        .match-start-dialog {
            clip-path: polygon(0 2%, 98% 0, 100% 98%, 2% 100%);
            position: absolute;
            background-color: #ccc;
            color: black;
            width: 400px;
            height: 250px;
            font-family: "Stick", sans-serif;
            font-weight: 400;
            font-style: normal;
            font-size: 2rem;
            justify-content: center;
            align-items: center;
            display: none;
            z-index: 1
        }

        .match-start-dialog.show {
            display: flex;
            animation: MatchStartDialogShow 0.25s ease-in forwards
        }

        .match-start-dialog.hide {
            display: flex;
            animation: MatchStartDialogHide 0.25s ease-in forwards
        }

        @keyframes MatchStartDialogShow {
            0% {
                top: calc(50% - 150px);
                left: calc(50% - 200px);
                opacity: 0
            }

            100% {
                top: calc(50% - 125px);
                left: calc(50% - 200px);
                opacity: 1
            }
        }

        @keyframes MatchStartDialogHide {
            0% {
                top: calc(50% - 125px);
                left: calc(50% - 200px);
                opacity: 1
            }

            100% {
                top: calc(50% - 100px);
                left: calc(50% - 200px);
                opacity: 0
            }
        }

        .fixed-background-in-div {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000
        }

        .fixed-background-in-div.show {
            display: block;
            animation: FadeInBackground 3s ease-in forwards
        }

        @keyframes FadeInBackground {
            0% {
                opacity: 0
            }

            10% {
                opacity: 0.5
            }

            90% {
                opacity: 0.5
            }

            100% {
                opacity: 1
            }
        }

        .notification-banner {
            display: none;
            position: fixed;
            /* 画面に固定 */
            top: 20px;
            /* 上から20px */
            /* right: 20px; */
            /* ここはアニメーションで制御するため削除またはコメントアウト */
            transform: translateX(100%);
            /* 初期位置：画面右端の外側 */
            background-color: #4caf50;
            /* 背景色（緑） */
            color: white;
            /* 文字色 */
            padding: 0;
            /* 内側の余白 */
            border-radius: 8px;
            /* 角を丸くする */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* 影 */
            /* display: flex; Flexboxを使って内容を配置 */
            align-items: center;
            /* 垂直方向中央揃え */
            z-index: 1000;
            /* 他の要素より手前に表示 */
            max-width: 300px;
            /* 最大幅 */
        }

        .notification-banner.show {
            display: block;
            /* アニメーションを追加 */
            animation: slideInFromRight 0.5s ease forwards;
            /* slideInFromRight: アニメーション名 */
            /* 0.5s: アニメーションの時間 */
            /* ease-out: 始まりは速く、終わりはゆっくり */
            /* forwards: アニメーション終了時の状態を保持 */
        }

        .notification-banner.hidden {
            animation: slideOutToRight 0.5s ease forwards;
        }

        .notification-banner p {
            margin: 0;
            flex-grow: 1;
            /* メッセージが残りのスペースを占める */
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-left: 15px;
            /* メッセージとの間にスペース */
        }

        .close-button:hover {
            color: #f0f0f0;
        }

        /* アニメーションの定義 */
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                /* 完全に右外 */
                right: 20px;
                /* 右端からの距離 */
            }

            to {
                transform: translateX(0);
                /* 通常の位置 */
                right: 20px;
                /* 右端からの距離 */
            }
        }

        @keyframes slideOutToRight {
            from {
                transform: translateX(0);
                right: 20px;
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                right: 20px;
                opacity: 0;
            }
        }

        p.message-text {
            margin: 10px;
        }

        /* プログレスバーのコンテナ */
        .progress-bar {
            position: absolute;
            /* 親要素の`container`を基準に配置 */
            bottom: 0;
            /* 親要素の底に配置 */
            left: 0;
            /* 親要素の左に配置 */
            width: 100%;
            height: 10px;
            background-color: #4caf50;
        }

        /* プログレスバーの進捗部分 */
        .progress-fill {
            height: 100%;
            width: 100%;
            background-color: #fffb00;
            transition: width 1s linear;
        }

        .notification-banner::after {
            font-family: 'Russo One', sans-serif;
            content: "R";
            position: absolute;
            top: 0;
            right: 10px;
            width: 65px;
            height: 65px;
            pointer-events: none;
            /* クリックを無効化 */
            font-size: 65px;
            opacity: 0.3;
            text-align: right;
        }
    </style>
</head>

<body>
    <audio src="sound/battle-start.wav" class="battle-start" hidden></audio>
    <audio src="sound/show-card.mp3" class="show-card" hidden></audio>

    <div class="fixed-background-in-div"></div>
    <div class="match-start-dialog">
        バトルを開始します!
    </div>

    <div class="match-user-card-container">
        <div class="match-user-card" id="MatchUserCardLeft">ユーザー1</div>
        <div class="match-user-card" id="MatchUserCardRight">ユーザー2</div>
    </div>

    <div class="vsBoom-stage" id="vsBoom-stage">
        <div class="vsBoom-text" id="vsBoom-text">VS</div>
        <div class="vsBoom-sparks
  
  " aria-hidden="true">
            <span style="--vsdx:-120px; --vsdy:-40px;"></span>
            <span style="--vsdx:100px; --vsdy:-80px;"></span>
            <span style="--vsdx:-70px; --vsdy:120px;"></span>
            <span style="--vsdx:140px; --vsdy:40px;"></span>
            <span style="--vsdx:-140px; --vsdy:80px;"></span>
            <span style="--vsdx:60px; --vsdy:160px;"></span>
            <span style="--vsdx:-30px; --vsdy:200px;"></span>
            <span style="--vsdx:220px; --vsdy:-20px;"></span>
            <span style="--vsdx:-200px; --vsdy:-120px;"></span>
            <span style="--vsdx:0px; --vsdy:-160px;"></span>
        </div>
    </div>
    <button class="Watch" hidden></button>
    <input class="user-name">
    <input class="user-name-to">
    <div class="request-list"></div>
    <div class="notification-banner" id="myNotificationBanner">
        <p class="message-text"><label class="request-from"></label><br>から対戦を申し込まれました!</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: 100%;"></div>
        </div>
    </div>
    <dialog class="accept_dialog">
        <label class="request-from"></label>と対戦しますか？
        <button onclick="accept(user_name,requested_name)">はい</button>
        <button onclick="close_accept()">いいえ</button>
    </dialog>
    <script type="module" src="connection.js"></script>
    <script>
        let username_input = document.querySelector(".user-name")
        let username_to_input = document.querySelector(".user-name-to")
        let request_time;
        let progress_bar_value;
        let user_name = "";
        let requested_name = "";
        let battle_started = false;
        // let requests = {};
        username_input.oninput = function () {
            user_name = document.querySelector(".user-name").value;
        }
        username_to_input.addEventListener("keydown", username_enter)
        let request_list = document.querySelector("div.request-list");
        setInterval(check_request, 100)
        function check_request() {
            request_list.innerHTML = "";
            // try {
            for (var i in requests) {
                if (requests[i].time + 30000 < new Date()) {
                    delete requests[i];
                    continue;
                }
                var new_value = document.createElement("p")
                new_value.innerHTML = `${requests[i].from} -> ${i} '(${parseInt(new Date() - requests[i].time) / 1000}秒前)`;
                request_list.appendChild(new_value);
                if (i == user_name && !battle_started) {
                    request_time = requests[i].time;
                    document.querySelectorAll(".request-from").forEach(function (e) {
                        e.innerHTML = requests[i].from;
                    });
                    requested_name = requests[i].from;
                    const banner = document.getElementById("myNotificationBanner");
                    banner.onclick = function () {
                        document.querySelector("dialog.accept_dialog").showModal();
                    }
                    banner.classList.add("show"); // hiddenクラスを追加
                    decrease_progress_bar();
                }
            }
            if (!battle_started) {
                isAccepted(sendTo);
            }
            // } catch (e) { }
        }
        function username_enter(e) {
            if (e.key === "Enter") {
                sendRequest(username_to_input.value);
                username_to_input.value = "";
            }
            return false;
        }
        function decrease_progress_bar() {
            progress_bar_value = 30 - parseInt(new Date() - request_time) / 1000;
            document.querySelector(".progress-fill").style.width = `${progress_bar_value / 30 * 100}%`;
            if (progress_bar_value < 0) {
                return closeNotification();
            }
            setTimeout(decrease_progress_bar, 1000)
        }
        function closeNotification() {
            const banner = document.getElementById("myNotificationBanner")
            banner.classList.add("hidden") // hiddenクラスを追加

            // アニメーションが終わったら要素を完全に非表示にする
            banner.addEventListener(
                "animationend",
                () => {
                    if (banner.classList.contains("hidden")) {
                        banner.classList.remove("hidden", "show");
                    }
                },
                { once: true },
            ) // 一度だけ実行されるように設定
        }
        function close_accept() {
            document.querySelector("dialog.accept_dialog").close();
        }
    </script>
</body>

</html>